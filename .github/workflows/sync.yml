on:
  push:
    branches: main
    paths:
      - "byoc-nuon/**"
  workflow_dispatch:
    inputs:
      NUON_DEBUG:
        description: NUON_DEBUG
        required: true
        default: "false"
        type: choice
        options:
          - true
          - false
defaults:
  run:
    shell: bash
env:
  NUON_DEBUG: "${{ github.event.inputs.NUON_DEBUG }}"

jobs:
  sync:
    runs-on: ubuntu-latest
    name: Push to Nuon
    steps:
      - name: Checkout code
        id: checkout
        uses: actions/checkout@v3

      - name: Check for skip-sync label
        id: check_label
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --search "${{ github.sha }}" --state merged --json number -q '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            LABELS=$(gh pr view "$PR_NUMBER" --json labels -q '.labels[].name')
            if echo "$LABELS" | grep -q "skip-sync"; then
              echo "skip=true" >> "$GITHUB_OUTPUT"
              echo "Skipping sync due to skip-sync label on PR #$PR_NUMBER"
            fi
          fi

      - name: Install CLI
        if: steps.check_label.outputs.skip != 'true'
        id: cli
        run: ./scripts/install-cli.sh

      # we can't sync to the BYOC org until the auth branch is merged
      # https://github.com/nuonco/byoc/pull/393
      # - name: Sync to BYOC(org4f5hq4tyo44legra6r4nm18)
      #   if: steps.check_label.outputs.skip != 'true'
      #   id: sync_to_org4f5hq4tyo44legra6r4nm18
      #   working-directory: byoc-nuon
      #   run: nuon apps sync .
      #   env:
      #     NUON_ORG_ID: org4f5hq4tyo44legra6r4nm18
      #     NUON_API_TOKEN: ${{ secrets.NUON_API_TOKEN_org4f5hq4tyo44legra6r4nm18 }}

      - name: Sync to retool(orggxqsc8f5zns1jra0oplc0ff)
        if: steps.check_label.outputs.skip != 'true'
        id: sync_to_orggxqsc8f5zns1jra0oplc0ff
        working-directory: byoc-nuon
        run: nuon apps sync .
        env:
          NUON_ORG_ID: orggxqsc8f5zns1jra0oplc0ff
          NUON_API_TOKEN: ${{ secrets.NUON_API_TOKEN_orggxqsc8f5zns1jra0oplc0ff }}
